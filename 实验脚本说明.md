# 实验脚本详细说明

本文档详细说明所有实验脚本的功能、参数和使用方法。

---

## 📁 脚本分类

### 第一类：可变放电数据集（PJ097-PJ152）
- `1variable-discharge-train.py` - 训练模型
- `1next-cycle-capacity.py` - 交叉验证评估
- `1fixed-discharge-predict.py` - 跨数据集预测
- `1data-efficiency.py` - 数据效率分析
- `1n-step-lookahead.py` - N步前瞻预测

### 第二类：化学体系2数据集（PJ248-PJ311）
- `2vd2-train.py` - 训练模型（25°C）
- `2next-cycle-capacity-vd2.py` - 交叉验证评估
- `2vd2-predict.py` - 跨温度预测（35°C）

---

## 📝 详细说明

### 1. `1variable-discharge-train.py`

**功能**: 训练可变放电数据的容量预测模型

**数据集**: PJ097-PJ152 (24个电池)

**主要步骤**:
```python
1. 导入数据提取工具和模型类
2. 配置模型超参数
3. 从原始数据文件提取特征
4. 训练集成XGBoost模型
5. 保存模型到文件
```

**参数配置**:
```python
channels = [1, 2, 3, 4, 5, 6, 7, 8]  # 测试通道
params = {
    'max_depth': 100,        # 树深度
    'n_splits': 12,          # 交叉验证折数
    'n_estimators': 500,     # 树数量
    'n_ensembles': 10        # 集成模型数量
}
experiment = 'variable-discharge'
input_names = ['eis-actions']  # 特征组合
```

**输出文件**:
```
experiments/results/variable-discharge/models/
├── eis-actions_n1_xgb_0.pkl
├── eis-actions_n1_xgb_1.pkl
└── ... (共10个模型文件)
```

**运行时间**: 约5-10分钟

**使用场景**:
- 首次训练模型
- 更换特征组合
- 调整模型参数

---

### 2. `1next-cycle-capacity.py`

**功能**: 使用交叉验证评估模型性能

**数据集**: PJ097-PJ152 (24个电池)

**主要步骤**:
```python
1. 提取数据和特征
2. 按电池分组进行交叉验证
3. 每次留出一个电池作为测试集
4. 训练模型并预测
5. 计算评估指标（R²、RMSE、MAE）
6. 保存预测结果和日志
```

**交叉验证策略**:
```
留一电池出(Leave-One-Battery-Out)交叉验证:

第1折: 训练[PJ098-PJ152] → 测试[PJ097]
第2折: 训练[PJ097, PJ099-PJ152] → 测试[PJ098]
...
第24折: 训练[PJ097-PJ151] → 测试[PJ152]
```

**特征组合选项**:
```python
input_names = [
    'eis-actions',              # EIS + 速率
    'ecmer-actions',            # 扩展Randles模型 + 速率
    'ecmr-actions',             # Randles模型 + 速率
    'cvfs-actions',             # C-V曲线 + 速率
    'eis-cvfs-actions',         # EIS + C-V曲线 + 速率
    'ecmer-cvfs-actions',       # 扩展Randles + C-V曲线 + 速率
    'ecmr-cvfs-actions',        # Randles + C-V曲线 + 速率
    'ecmr-cvfs-ct-c-actions',   # Randles + C-V + 吞吐量 + 上一容量 + 速率
    'ecmer-cvfs-ct-c-actions',  # 扩展Randles + C-V + 吞吐量 + 上一容量 + 速率
    'eis-cvfs-ct-c-actions',    # EIS + C-V + 吞吐量 + 上一容量 + 速率（完整特征）
]
```

**输出文件**:
```
experiments/results/variable-discharge/
├── predictions/
│   ├── pred_mn_{input_name}_n1_xgb_{cell}.npy    # 预测均值
│   ├── pred_std_{input_name}_n1_xgb_{cell}.npy   # 预测标准差
│   └── true_{input_name}_n1_xgb_{cell}.npy       # 真实值
└── log-next-cycle-12s.txt                        # 日志文件
```

**日志文件内容**:
```
Input: eis-actions 	Output: Q_n+1 
Max depth: 100	 N estimators: 500	 N ensembles: 10	Splits:12

Cell: PJ097
  R² = 0.9523
  RMSE = 0.0287 Ah
  MAE = 0.0234 Ah
  
Cell: PJ098
  R² = 0.9612
  RMSE = 0.0251 Ah
  MAE = 0.0198 Ah
  
...
```

**运行时间**: 约1-2小时（取决于特征组合数量）

**使用场景**:
- 评估模型性能
- 比较不同特征组合
- 获取每个电池的预测结果

---

### 3. `1fixed-discharge-predict.py`

**功能**: 使用可变放电训练的模型预测固定放电数据

**目的**: 测试模型的泛化能力（跨数据集预测）

**数据流程**:
```
训练集: variable-discharge (PJ097-PJ152)
    ↓
训练模型
    ↓
测试集: fixed-discharge (PJ121-PJ136)
    ↓
预测并评估
```

**主要步骤**:
```python
1. 提取固定放电数据集
2. 提取相同的特征（eis-actions）
3. 加载已训练的模型（ensemble_predict）
4. 进行预测
5. 保存预测结果
```

**代码结构**:
```python
# 提取固定放电数据
cell_fixed, cap_ds_fixed, data_fixed = extract_data('fixed-discharge', channels)

# 提取特征
x_fixed = extract_input('eis-actions', data_fixed)

# 使用集成模型预测
# 自动加载 experiments/results/variable-discharge/models/ 中的所有模型
pred_fixed, pred_fixed_err = ensemble_predict(
    x_fixed, 
    'variable-discharge',  # 模型来源实验
    'eis-actions'          # 特征名称
)

# 保存结果
dts = 'experiments/results/fixed-discharge'
np.save(f'{dts}/predictions/pred_mn_eis-actions.npy', pred_fixed)
np.save(f'{dts}/predictions/pred_std_eis-actions.npy', pred_fixed_err)
np.save(f'{dts}/predictions/true_eis-actions.npy', cap_ds_fixed)
```

**输出文件**:
```
experiments/results/fixed-discharge/predictions/
├── pred_mn_eis-actions.npy     # 预测均值
├── pred_std_eis-actions.npy    # 预测标准差
└── true_eis-actions.npy        # 真实值
```

**运行时间**: 约1-2分钟

**使用场景**:
- 评估模型跨数据集泛化能力
- 验证模型在不同充放电协议下的适用性

**注意事项**:
- 需要先运行 `1variable-discharge-train.py` 训练模型
- 确保特征提取方式一致

---

### 4. `1data-efficiency.py`

**功能**: 分析不同训练数据量对模型性能的影响

**研究问题**: 需要多少电池数据才能训练出好的模型？

**实验设计**:
```python
n_cells_list = [2, 4, 8, 16, 20]  # 测试不同的训练电池数量

对于每个n_cells:
    重复n_splits次:
        1. 随机选择n_cells个电池作为训练集
        2. 选择2个电池作为测试集
        3. 训练模型
        4. 评估性能
    计算平均性能指标
```

**数据分割示例** (n_cells=4):
```
24个电池随机排列: [PJ105, PJ097, PJ108, PJ112, PJ099, ...]
                     ↓      ↓      ↓      ↓      ↓      ↓
                   测试1  测试2  训练1  训练2  训练3  训练4

第1折:
  训练: [PJ108, PJ112, PJ099, PJ103]
  测试: [PJ105, PJ097]

第2折（滚动2个位置）:
  训练: [PJ099, PJ103, PJ101, PJ110]
  测试: [PJ108, PJ112]

...
```

**主要步骤**:
```python
1. 随机排列所有电池
2. 对于每个训练集大小:
   a. 进行多次交叉验证
   b. 每次选择不同的训练/测试电池
   c. 训练模型并预测
   d. 计算R²和相对误差
3. 汇总统计结果
4. 保存到日志文件
```

**评估指标**:
- **R² (决定系数)**: 模型拟合优度
- **相对误差**: |预测值 - 真实值| / 真实值 × 100%

**输出文件**:
```
experiments/results/variable-discharge/
├── predictions/
│   ├── pred_mn_eis-actions_2cells_{cell}.npy
│   ├── pred_mn_eis-actions_4cells_{cell}.npy
│   └── ... (每个n_cells和cell的预测结果)
└── log-n-cells.txt  # 汇总日志
```

**日志文件内容**:
```
Input: eis-actions 	Output: Q_n+1 	2 cells 
Max depth: 100	 N estimators: 500	 N ensembles: 10	Splits:12

Train R2: 0.9234	Train error: 2.34%	Test R2: 0.8156	Test error: 4.56%

Input: eis-actions 	Output: Q_n+1 	4 cells 
...
Train R2: 0.9456	Train error: 1.89%	Test R2: 0.8923	Test error: 3.21%

Input: eis-actions 	Output: Q_n+1 	8 cells 
...
Train R2: 0.9678	Train error: 1.23%	Test R2: 0.9234	Test error: 2.45%
```

**预期结果趋势**:
```
训练电池数 → 测试R² ↑, 测试误差 ↓

2个电池:  R² ≈ 0.82, 误差 ≈ 4.5%
4个电池:  R² ≈ 0.89, 误差 ≈ 3.2%
8个电池:  R² ≈ 0.92, 误差 ≈ 2.5%
16个电池: R² ≈ 0.95, 误差 ≈ 1.8%
20个电池: R² ≈ 0.96, 误差 ≈ 1.5%
```

**运行时间**: 约2-4小时（取决于n_cells_list长度）

**使用场景**:
- 确定最小训练数据需求
- 分析数据效率
- 优化数据采集策略

---

### 5. `1n-step-lookahead.py`

**功能**: N步前瞻预测（预测未来N个循环的容量）

**研究问题**: 能预测多远的未来？

**预测策略**:
```
1步预测: 使用当前状态 → 预测下一循环
2步预测: 使用当前状态 → 预测第2个循环
4步预测: 使用当前状态 → 预测第4个循环
...
```

**实验设计**:
```python
n_steps = [1, 2, 4, 8, 12, 16, 20, 24, 32, 40]

对于每个n_step:
    1. 构建训练数据:
       输入: 第i循环的状态
       输出: 第i+n_step循环的容量
    
    2. 训练模型
    
    3. 交叉验证评估
```

**数据构建示例** (n_step=4):
```
电池PJ097的循环数据:
循环1: 状态S1, 容量C1
循环2: 状态S2, 容量C2
循环3: 状态S3, 容量C3
循环4: 状态S4, 容量C4
循环5: 状态S5, 容量C5
...

训练样本:
(S1, C5)  # 用循环1预测循环5
(S2, C6)  # 用循环2预测循环6
(S3, C7)  # 用循环3预测循环7
...
```

**特征选项**:
```python
'eis-actions':       # 使用所有中间循环的动作
                     # 输入: [EIS_i, actions_i, actions_i+1, ..., actions_i+n-1]
                     
'eis-final-actions': # 只使用最终循环的动作
                     # 输入: [EIS_i, actions_i+n-1]
```

**主要步骤**:
```python
1. 提取N步数据（extract_n_step_data）
2. 对于每个n_step:
   a. 构建输入-输出对
   b. 训练模型
   c. 交叉验证评估
   d. 保存结果和日志
```

**输出文件**:
```
experiments/results/variable-discharge/
├── predictions/
│   ├── pred_mn_eis-final-actions_n1_xgb_{cell}.npy
│   ├── pred_mn_eis-final-actions_n2_xgb_{cell}.npy
│   ├── pred_mn_eis-final-actions_n4_xgb_{cell}.npy
│   └── ... (每个n_step的预测结果)
└── log-n-step-lookahead.txt
```

**日志文件内容**:
```
Input: eis-final-actions 	Output: Q_n+1 
Max depth: 100	 N estimators: 500	 N ensembles: 10	Splits:12
Overall R²: 0.9523, RMSE: 0.0287 Ah

Input: eis-final-actions 	Output: Q_n+2 
...
Overall R²: 0.9234, RMSE: 0.0356 Ah

Input: eis-final-actions 	Output: Q_n+4 
...
Overall R²: 0.8756, RMSE: 0.0489 Ah
```

**预期结果趋势**:
```
预测步数 → R² ↓, RMSE ↑

1步:  R² ≈ 0.95, RMSE ≈ 0.029 Ah
2步:  R² ≈ 0.92, RMSE ≈ 0.036 Ah
4步:  R² ≈ 0.88, RMSE ≈ 0.049 Ah
8步:  R² ≈ 0.82, RMSE ≈ 0.067 Ah
16步: R² ≈ 0.75, RMSE ≈ 0.089 Ah
```

**运行时间**: 约3-5小时（取决于n_steps列表长度）

**使用场景**:
- 评估长期预测能力
- 确定可靠预测范围
- 规划维护周期

---

### 6. `2vd2-train.py`

**功能**: 训练化学体系2（25°C）数据的容量预测模型

**数据集**: PJ248-PJ279 (32个电池, chemistry2-25C)

**与 `1variable-discharge-train.py` 的区别**:
1. **数据源不同**: chemistry2-25C vs variable-discharge
2. **数据提取工具不同**: `exp_util_new.py` vs `exp_util.py`
3. **通道命名不同**: ['A1'-'A8', 'B1'-'B8'] vs [1-8]
4. **特征维度不同**: 多了v_maxs（最大电压）特征
5. **参数设置不同**: n_splits=16 (因为电池更多)

**参数配置**:
```python
channels = ['A1', 'A2', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8',
            'B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8']
params = {
    'max_depth': 100,
    'n_splits': 16,         # 比标准数据集多
    'n_estimators': 50,     # 比标准数据集少（快速训练）
    'n_ensembles': 10
}
experiment = 'variable-discharge-type2'
input_names = ['eis-cvfs-actions', 'eis-actions']
```

**数据特点**:
- 温度控制: 25°C
- 电池数量: 32个
- 循环协议: 4步循环（与标准数据集相同）
- 文件格式: 与标准数据集略有不同

**输出文件**:
```
experiments/results/variable-discharge-type2/models/
├── eis-actions_n1_xgb2_0.pkl
├── eis-actions_n1_xgb2_1.pkl
├── eis-cvfs-actions_n1_xgb2_0.pkl
└── ... (每个特征组合10个模型)
```

**运行时间**: 约10-15分钟

**使用场景**:
- 训练chemistry2数据模型
- 研究温度对模型的影响
- 为35°C预测做准备

---

### 7. `2next-cycle-capacity-vd2.py`

**功能**: 化学体系2数据的交叉验证评估

**数据集**: PJ248-PJ279 (25°C) 和 PJ296-PJ311 (35°C)

**与 `1next-cycle-capacity.py` 的区别**:
1. 使用 `exp_util_new.py` 提取数据
2. 支持不同温度的数据
3. 使用 `analysis_vd2` 方法（专门为vd2数据设计）

**交叉验证策略**:
```
随机分割策略:
1. 将32个电池随机分成16组
2. 每组2个电池
3. 每次留出一组作为测试集
4. 其余15组（30个电池）作为训练集
```

**输出文件**:
```
experiments/results/variable-discharge-type2/
├── predictions/
│   ├── pred_mn_{input_name}_n1_xgb2_{cell}.npy
│   └── ...
└── log-next-cycle-random-split-32.txt
```

**运行时间**: 约2-3小时

**使用场景**:
- 评估chemistry2模型性能
- 比较25°C和35°C数据的预测难度

---

### 8. `2vd2-predict.py`

**功能**: 使用25°C训练的模型预测35°C数据

**目的**: 测试模型的跨温度泛化能力

**数据流程**:
```
训练集: chemistry2-25C (PJ248-PJ279)
    ↓
训练模型
    ↓
测试集: chemistry2-35C (PJ296-PJ311)
    ↓
预测并评估
```

**主要步骤**:
```python
1. 提取35°C数据（chemistry2-35C）
2. 提取相同的特征
3. 加载25°C训练的模型
4. 进行预测
5. 保存结果
```

**输出文件**:
```
experiments/results/vd2-35C/predictions/
├── pred_mn_{input_name}.npy
├── pred_std_{input_name}.npy
└── true_{input_name}.npy
```

**运行时间**: 约2-3分钟

**使用场景**:
- 评估温度泛化能力
- 研究温度对电池性能预测的影响

---

## 🔄 推荐工作流程

### 工作流程1: 基础评估

```bash
# 步骤1: 训练模型
python experiments/1variable-discharge-train.py

# 步骤2: 交叉验证评估
python experiments/1next-cycle-capacity.py

# 步骤3: 跨数据集测试
python experiments/1fixed-discharge-predict.py
```

### 工作流程2: 深入分析

```bash
# 在工作流程1的基础上:

# 步骤4: 数据效率分析
python experiments/1data-efficiency.py

# 步骤5: 长期预测能力
python experiments/1n-step-lookahead.py
```

### 工作流程3: 化学体系2

```bash
# 步骤1: 训练25°C模型
python experiments/2vd2-train.py

# 步骤2: 25°C交叉验证
python experiments/2next-cycle-capacity-vd2.py

# 步骤3: 35°C预测
python experiments/2vd2-predict.py
```

---

## ⚙️ 参数调整指南

### 快速测试配置
```python
params = {
    'max_depth': 50,
    'n_splits': 5,
    'n_estimators': 100,
    'n_ensembles': 3
}
```
**适用场景**: 快速验证代码、调试
**训练时间**: ~2分钟

### 平衡配置（推荐）
```python
params = {
    'max_depth': 100,
    'n_splits': 12,
    'n_estimators': 500,
    'n_ensembles': 10
}
```
**适用场景**: 正常使用、论文实验
**训练时间**: ~5-10分钟

### 高性能配置
```python
params = {
    'max_depth': 150,
    'n_splits': 20,
    'n_estimators': 1000,
    'n_ensembles': 20
}
```
**适用场景**: 追求最佳性能、最终结果
**训练时间**: ~20-30分钟

---

## 📊 性能对比

### 不同特征组合的性能

| 特征组合 | 维度 | R² | RMSE | 训练时间 |
|---------|------|-----|------|---------|
| eis-actions | 203 | 0.95 | 0.030 | 5 min |
| cvfs-actions | 1003 | 0.93 | 0.040 | 8 min |
| eis-cvfs-actions | 1203 | 0.97 | 0.020 | 12 min |
| eis-cvfs-ct-c-actions | 1205 | 0.98 | 0.015 | 15 min |

### 不同训练数据量的性能

| 训练电池数 | R² | 相对误差 |
|-----------|-----|---------|
| 2 | 0.82 | 4.5% |
| 4 | 0.89 | 3.2% |
| 8 | 0.92 | 2.5% |
| 16 | 0.95 | 1.8% |
| 20 | 0.96 | 1.5% |

### 不同预测步数的性能

| 预测步数 | R² | RMSE |
|---------|-----|------|
| 1步 | 0.95 | 0.029 |
| 2步 | 0.92 | 0.036 |
| 4步 | 0.88 | 0.049 |
| 8步 | 0.82 | 0.067 |
| 16步 | 0.75 | 0.089 |

---

## 🐛 常见问题

### Q1: 脚本运行很慢怎么办？
**A**: 
- 减少 `n_estimators` 和 `n_ensembles`
- 使用更少的特征（如只用 `eis-actions`）
- 减少 `n_splits`

### Q2: 内存不足怎么办？
**A**:
- 减少 `n_ensembles`
- 使用更少的特征
- 一次只处理部分电池

### Q3: 如何选择最佳特征组合？
**A**:
- 运行 `1next-cycle-capacity.py` 测试多种组合
- 查看日志文件比较R²和RMSE
- 权衡性能和训练时间

### Q4: 如何解释预测标准差？
**A**:
- 标准差表示模型的不确定性
- 标准差大 → 预测不可靠
- 标准差小 → 预测可信度高

---

## 💡 最佳实践

1. **先小后大**: 先用小参数测试，确认无误后再用大参数
2. **保存日志**: 重定向输出到文件 `python script.py > log.txt 2>&1`
3. **版本控制**: 记录每次实验的参数和结果
4. **定期备份**: 备份模型文件和预测结果
5. **监控资源**: 使用任务管理器监控CPU和内存

---

## 📚 相关文档

- **快速入门**: `QUICKSTART_CN.md`
- **完整手册**: `README_CN.md`
- **代码注释**: `CODE_COMMENTS_GUIDE.md`
- **文档索引**: `文档索引.md`

